<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Music</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div id="player">
  <iframe
    id="playframe"
    src="https://www.youtube.com/embed/agPF9Eptt1s?autoplay=1&enablejsapi=1"
    width="560"
    height="315"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen
  >
  </iframe>
</div>
</body>
<script src="https://www.youtube.com/iframe_api"></script>
<script>
    let currentSong;
    let queue;
    const socket = io(window.location.origin.endsWith(":3000") ? window.location.origin.replace("3000", "3001") : window.location.origin.concat(":3001"));
    socket.on("songRequest", (data) => {
        queue = data.queue;
        let index = data.index;

        if (index === 0) {
            currentSong = queue[0];
            playSong(currentSong.song.id);
        }
    });
    let player = document.getElementById("playframe");

    window.onYouTubeIframeAPIReady = () => {
        new YT.Player("playframe");
    };

    window.addEventListener("message", (e) => {
        if (e.origin === "https://www.youtube.com") {
            let playerData = JSON.parse(e.data);
            if (
                playerData.event === "infoDelivery" &&
                playerData.info.playerState === YT.PlayerState.ENDED
            ) {
                if (queue.length > 0) {
                    queue.shift();
                    if (queue.length > 0) {
                        currentSong = queue[0];
                        playSong(currentSong.song.id);
                    }
                    socket.emit("songEnded");
                }
            }
        }
    });

    function playSong (songID) {
        player.src = `https://www.youtube.com/embed/${songID}?autoplay=1&enablejsapi=1`;
    }
</script>
</html>